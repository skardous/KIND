@(id: Long, eventForm: Form[Evenement], event: Evenement)

@import helper._

@implicitFieldConstructor = @{ FieldConstructor(twitterBootstrapInput.render) } 

@partiField(field: Field, className: String = "part") = {
	@input(field, '_label -> "Participants", '_class -> className) { (id, name, value, _) =>
	<input type="text" name="@name" value="@value"> 
	<a class="removeParti btn danger">Remove</a>
	}
}

@main("Editer un evenement") {

	<h1>Participants pour: @event.getTitre</h1><br/>

	
			Titre de l'&eacute;venement : <b>@event.getTitre</b> <br/>
			Cr&eacute;ateur : <b>@event.getCreateur</b> <br/>
			Description : <i>@event.getDescriptif</i> <br/>			
	



<table cellspacing="5" cellpadding="5">
	<tbody id="mainBody">
		<tr class="titres" style="display:none"><td style="visibility:hidden"></td>
			@for(jour <- event.jours) {  					  
				<td id="@jour.id" class="jour" colspan="@jour.horaires.size()"><b>@jour.date</b></td>	                        	                
			}
		</tr>
		<tr class="titres" style="display:none"><td style="visibility:hidden"></td>
			@for(jour <- event.jours) {  
			  @if(jour.horaires.size() == 0){
			    <td class="jour"></td>
			  }
			     @for(horaire <- jour.horaires) {
			    	 <td id="@horaire.id" day="@jour.date" class="horaire">@horaire.debut - @horaire.fin</td>
			     }            	                
			}
		</tr>
		              
		
		@for(participant <- event.participants) {
			<tr id="@participant.getId()"><td class="infoPersonne">
				@form(routes.Application.updatePersonne(id), 'id->"formPersonne") {
					<input id="nom" type="text" value="@participant.getNom()" name="nom" readonly="readonly">	
				
					<a id="@participant.getId()" class="editPersonne btn"> Editer<i class="icon-pencil"></i></a>
					<a id="@participant.getId()" class="deletePersonne btn btn-danger"> Supprimer<i class="icon-trash"></i></a>
				}</td>
				
				@for(jour <- event.jours) {
				    @if(jour.horaires.size() == 0){
				      @if(participant.inscriptionsJours.contains(jour)) {
		                <td class="checktd"><input id="@jour.id" type="checkbox" checked class="jour checkbox" value="@jour.date" /></td>
		              } else {
		                 <td class="checktd"><input id="@jour.id" type="checkbox" class="jour checkbox" value="@jour.date" /></td>
		              }
				       
				    }
		            @for(horaire <- jour.horaires) {
		              @if(participant.inscriptionsHoraires.contains(horaire)) {
		                <td class="checktd"><input id="@horaire.id" type="checkbox" class="horaire checkbox"  checked value="@horaire.debut - @horaire.fin" /></td>
		              } else {
		                 <td class="checktd"><input id="@horaire.id" type="checkbox" class="horaire checkbox" value="@horaire.debut - @horaire.fin" /></td>
		              }
		            }            	                
		        }				
			</tr>
		}
	
	<tr id="compte" class="titres" style="display:none">
		<td id=""><b>Compte: </b></td>
		@for(jour <- event.jours) {
		    @if(jour.horaires.size() == 0){		     
                <td id="@jour.id" class="jour">0</td>	       
		    }
            @for(horaire <- jour.horaires) {              
                <td id="@horaire.id" class="horaire">0</td>              
            }
		}
	</tr>
	</tbody>
	<tfoot>
		<tr>
			<td> Date(s) populaire(s) :</td>
			<td colspan="0" class="footer"></td>
		</tr>
	</tfoot>


	
</table>

Ajouter :		  
<input id="champ" type="text" value=""><a id="ajouter" class="btn">Ajouter</a><br>

<br>
<h3>Inviter des copains</h3>

<div class="selectDate">
<textarea id="mailsArea" rows="4"></textarea>
<a id="envoiLien" class="btn btn-info">Envoyer Lien</a>
</div>

<script type="text/javascript" charset="utf-8">

$(function(){ 
	$('.checkbox').each(function (i) {
	  	if ($(this).is(':checked')){
	  		$(this).parent().css("background-color", "#66CC99");
	  	}
	});

	$('.infoPersonne').each(function (i) {
	  $('.titres').attr('style','');
	});



	$('input[type="checkbox"]').each(function(i) {
	var iden = $(this).attr('id');

	if ($(this).attr('class') == 'horaire checkbox') {
		if ($(this).is(':checked')){
	    	var increment = $('#compte').children('.horaire[id="'+iden+'"]');
			increment.html(parseInt(increment.html())+1);
		}
	}
	if ($(this).attr('class') == 'jour checkbox') {
		if ($(this).is(':checked')){
	    	var increment = $('#compte').children('.jour[id="'+iden+'"]');
			increment.html(parseInt(increment.html())+1);
		}
	}
	});

	var max = 0;
	$("#compte").children().each( function() {
		$(this).css("background-color", "#A0A0A0") //gris
		$('.titres').children().css("background-color","#A0A0A0");		
		if ($(this).html() > max) {			
			max = $(this).html();
		}
	})
	$("#compte").children().each( function() {		
		if ($(this).html() == max && $(this).html() != 0) {			
			$(this).css("background-color", "black");
			//alert("classe : "+$(this).attr("class")+" id : "+$(this).attr("id"));
			$('td[id="'+$(this).attr("id")+'"][class="'+$(this).attr("class")+'"]').css("background-color", "black");
			if($(this).attr("class") == "horaire") {
				var day = $('td[id="'+$(this).attr("id")+'"][class="'+$(this).attr("class")+'"]').attr("day");				
				$("td:contains('"+day+"')").css("background-color", "black");
				
			}
		}
	})
  
});


$('#envoiLien').live('click', function(e) {
  var mailsList = $("#mailsArea").val();
  
	$.ajax({
		type: "POST",
		url: "@routes.Application.sendMail(id)",
		data: '{"mailslist" : "' + mailsList + '"}',
		contentType: "application/json",
		success : function(data) {
		  alert("Mail(s) envoye(s) a "+mailsList);
		}
   });
});
	  
	  
$('.deletePersonne').live('click', function(e) {    
    $(this).parent().parent().parent().remove();
    renumber();   
    deletePersonne($(this).attr('id'));
    if($('td[class="infoPersonne"]').html() == null) {
    	$('.titres').attr('style','display:none');
    }
    $('#compte').children('td[id!=""]').each(function(i) {$(this).html("0")});
    $('input[type="checkbox"]').each(function(i) {
    var iden = $(this).attr('id');
  
    if ($(this).attr('class') == 'horaire') {
    	if ($(this).is(':checked')){
	    	var increment = $('#compte').children('.horaire[id="'+iden+'"]');
			increment.html(parseInt(increment.html())+1);
    	}
    }
    if ($(this).attr('class') == 'jour') {
    	if ($(this).is(':checked')){
	    	var increment = $('#compte').children('.jour[id="'+iden+'"]');
			increment.html(parseInt(increment.html())+1);
    	}
    }
  });
})

$('.editPersonne').live('click', function(e) {
    if($(this).html() == "<i class=\"icon-pencil\"></i>")  {
      $(this).html("OK");
      $(this).attr("class", "editPersonne btn btn-success");
      $(this).siblings("input").removeAttr("readonly");
    } else {
      $(this).html("<i class=\"icon-pencil\"></i>");
      $(this).attr("class", "editPersonne btn");
      $(this).siblings("input").attr("readonly", "readonly");
      renumber();      
      editPersonne($(this).attr('id'), $(this).siblings("input").attr("value"));
    }
  
})





$("#ajouter").live('click', function(e){
  
    envoiPersonne($("#champ"));
});




function envoiPersonne(self)
{
    var vide = "";
    var nom = self.attr("value");
    if (vide != nom) {      
		addPersonne($("#champ").attr('value'));			
	}
}

function editPersonne(personneId, personneNom)
{
  $.ajax({
		type: "POST",
		url: "@routes.Application.updatePersonne(id)",
		data: '{"id" : "' + personneId + '", "nom" : "' + personneNom + '"}',
		contentType: "application/json",
		success : function(data) {
		  //alert("Participant edit\351");
		}
  });
}

function deletePersonne(persId)
{
  $.ajax({
		type: "POST",
		url: "@routes.Application.deleteParticipant(id)",
		data: '{"id" : "' + persId + '"}',
		contentType: "application/json",
		success : function(data) {
		  //alert("Participant supprim\351");
		}
  });
}

function addPersonne(nomParticipant)
{	
	$.ajax({
		type: "POST",
		url: "@routes.Application.addParticipant(id)",
		data: '{"nom" : "' + nomParticipant + '"}',
		contentType: "application/json",
		success : function(data) {		  
		  $("#mainBody").append("<tr id=\""+data.idPersonne+"\"><td class=\"infoPersonne\">"+
				  "<form id=\"formPersonne\">"+
				  "<input id=\"nom\" type=\"text\" value=\""+nomParticipant+"\" name=\"nom\" readonly=\"readonly\">&nbsp;"+
				  "<a id=\""+data.idPersonne+"\" class=\"editPersonne btn\">Editer<i class=\"icon-pencil\"></i></a>&nbsp;"+
				  "<a id=\""+data.idPersonne+"\" class=\"deletePersonne btn btn-danger\">Supprimer<i class=\"icon-trash\"></i></a>"+				  
				 "</form></td>"+
				  "@for(jour <- event.jours) {"+  
				  	"@if(jour.horaires.size() == 0){<td class=\"checktd\"><input id=\"@jour.id\" type=\"checkbox\" class=\"jour checkbox\" value=\"@jour.date\" /></td>}"+
	                	"@for(horaire <- jour.horaires) {"+	                		
			                 "<td class=\"checktd\"><input id=\"@horaire.id\" type=\"checkbox\" class=\"horaire checkbox\" value=\"@horaire.debut - @horaire.fin\" /></td>"+			                
	                	"}"+                	                
                  "}" +
				"</tr>")
		  $('#champ').attr('value', '')
		  $('.titres').attr('style','');
		}               
	});
}


$('.checktd').live('click', function(e) {
      
	if ($(this).children().prop("checked") == false) {
	  if (e.target.nodeName == "TD"){
	  	$(this).children().prop("checked", true);
	  }
	  changeCheck($(this).children());
	} else {
	if (e.target.nodeName == "TD"){
	  	$(this).children().prop("checked", false);
	}        
	changeCheck($(this).children());
	}
	var max = 0;
	$("#compte").children().each( function() {
		$(this).css("background-color", "#A0A0A0") //gris
		$('.titres').children().css("background-color","#A0A0A0");
		$('.footer').html("");
		if ($(this).html() > max) {			
			max = $(this).html();
		}
	})
	$("#compte").children().each( function() {		
		if ($(this).html() == max && $(this).html() != 0) {			
			$(this).css("background-color", "black");
			//alert("classe : "+$(this).attr("class")+" id : "+$(this).attr("id"));
			$('td[id="'+$(this).attr("id")+'"][class="'+$(this).attr("class")+'"]').css("background-color", "black");
			if($(this).attr("class") == "horaire") {
				var day = $('td[id="'+$(this).attr("id")+'"][class="'+$(this).attr("class")+'"]').attr("day");				
				$("td:contains('"+day+"')").css("background-color", "black");
				$('.footer').append(day);
			}
		}
	})



});



$(".checktd").hover(  
  function () {  	
    $(this).css("background-color", "lightgreen");
    
  },
  function () {
  	if ($(this).children().is(':checked')){	 
    	$(this).css("background-color", "#66CC99");
    } else {
    	$(this).css("background-color", "#A0A0A0");
    }

  }
);


function changeCheck(box) {   
   var idtime = box.attr('id');
   var idParticipant = box.parent().parent().attr('id');   
   
   if (box.is(':checked')){	   		
       		box.parent().css("background-color", "#66CC99")//vert
	   		if (box.attr('class') == 'horaire checkbox') {
	           var increment = $('#compte').children('.horaire[id="'+idtime+'"]');
		   	   increment.html(parseInt(increment.html())+1);
	       	   requeteAjaxHeure(idtime, idParticipant);
		    }
       		if (box.attr('class') == 'jour checkbox') {	
    	   	   var increment = $('#compte').children('.jour[id="'+idtime+'"]');
		   	   increment.html(parseInt(increment.html())+1);
			   requeteAjaxJour(idtime, idParticipant);
		   }
   } else {
     
     box.parent().css("background-color", "#A0A0A0")//gris
     if (box.attr('class') == 'horaire checkbox') {
	     var increment = $('#compte').children('.horaire[id="'+idtime+'"]');
	     increment.html(parseInt(increment.html())-1);
	     requeteAjaxHeure(idtime, idParticipant);
     }
     if (box.attr('class') == 'jour checkbox') {
        var increment = $('#compte').children('.jour[id="'+idtime+'"]');
	    increment.html(parseInt(increment.html())-1);
	    requeteAjaxJour(idtime, idParticipant);
     }
   }
   
   
}

function requeteAjaxJour(idtime, idParticipant)
{
  $.ajax({
		type: "POST",
		url: "@routes.Application.checkBoxJour(id)",
		data: '{"idjour" : "' + idtime + '", "idpersonne" : "' + idParticipant + '"}',
		contentType: "application/json",
		success : function(data) {
		  //alert("Jour edit\351");
		}
   });
}

function requeteAjaxHeure(idtime, idParticipant)
{
  $.ajax({
		type: "POST",
		url: "@routes.Application.checkBoxHoraire(id)",
		data: '{"idhoraire" : "' + idtime + '", "idpersonne" : "' + idParticipant + '"}',
		contentType: "application/json",
		success : function(data) {
		  //alert("Horaire edit\351");
		}
   });
}



</script>

}
