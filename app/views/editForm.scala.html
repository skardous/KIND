@(event: Evenement)

@import helper._

@implicitFieldConstructor = @{ FieldConstructor(twitterBootstrapInput.render) } 


@main("Editer un evenement") {

	<h1>Participants pour: @event.titre</h1><br/>

	
	Titre de l'&eacute;venement : <b>@event.titre</b> <br/>
	Cr&eacute;ateur : <b>@event.createur</b> <br/>

	@if(event.descriptif != "") {
	Description : <i>@event.descriptif</i> <br/>	
	}			
	
	<a class="btn btn-danger" href="@routes.Application.deleteEvent(event.id)">Supprimer l'evenement</a>
	
	<table class="datesTable" cellspacing="5" cellpadding="5">
		<tbody>
			<tr class="titres" style="display:none"><td style="visibility:hidden"></td>
				@for(jour <- event.jours) {  					  
					<td id="@jour.id" class="jour" colspan="@jour.horaires.size()"><b>@jour.date</b></td>	                        	                
				}
			</tr>
			<tr class="titres" style="display:none"><td style="visibility:hidden"></td>
				@for(jour <- event.jours) {  
				  @if(jour.horaires.size() == 0){
				    <td class="jour"></td>
				  }
				     @for(horaire <- jour.horaires) {
				    	 <td id="@horaire.id" day="@jour.date" class="horaire">@horaire.debut - @horaire.fin</td>
				     }            	                
				}
			</tr>
			              
			
			@for(participant <- event.participants) {
				<tr title="@participant.nom" id="@participant.id"><td class="infoPersonne">
					@form(routes.Application.updatePersonne(event.id), 'id->"formPersonne") {
						@if(participant.locked){
							<i class="mesicones icon-lock"></i>
						}
						@if(participant.obligatoire){							
							<a id="obligatoire" class="obligatoirecb btn btn-inverse">Obligatoire</a>
						} else {								
							<a id="obligatoire" class="obligatoirecb btn ">Facultatif</a>
						}

						<input id="nom" size="10" type="text" value="@participant.nom" name="nom" readonly="readonly">							
						<a id="@participant.id" title="Editer le participant" class="editPersonne"><i class="mesicones icon-pencil"></i></a>
						<a id="@participant.id" title="Supprimer le participant" class="deletePersonne"> <i class="mesicones icon-trash"></i></a>
					}</td>
					
					@for(jour <- event.jours) {
					    @if(jour.horaires.size() == 0){
					      @if(participant.inscriptionsJours.contains(jour)) {
			                <td class="checktd"><input id="@jour.id" type="checkbox"  disabled checked class="jour checkbox" value="@jour.date" /></td>
			              } else {
			                 <td class="checktd"><input id="@jour.id" type="checkbox"  disabled class="jour checkbox" value="@jour.date" /></td>
			              }
					       
					    }
			            @for(horaire <- jour.horaires) {
			              @if(participant.inscriptionsHoraires.contains(horaire)) {
			                <td class="checktd"><input id="@horaire.id" type="checkbox" disabled class="horaire checkbox"  checked value="@horaire.debut - @horaire.fin" /></td>
			              } else {
			                 <td class="checktd"><input id="@horaire.id" type="checkbox" disabled class="horaire checkbox" value="@horaire.debut - @horaire.fin" /></td>
			              }
			            }            	                
			        }				
				</tr>
			}
		</tbody>
		<tfoot>
		<tr id="compte" class="titres"
		 @if(event.participants.size() == 0){ style="display:none"}>
			<td id=""><b>Compte: </b></td>
			@for(jour <- event.jours) {
			    @if(jour.horaires.size() == 0){		     
	                <td id="@jour.id" class="jour">0</td>	       
			    }
	            @for(horaire <- jour.horaires) {              
	                <td id="@horaire.id" class="horaire">0</td>              
	            }
			}
		</tr>
		
		
			<!--<tr>
				<td> Date(s) populaire(s) :</td>
				<td colspan="0" class="footer"></td>
			</tr>-->
		</tfoot>

		<!--<div class="populaires"></div>-->


		
	</table>
	
	
	

	Ajouter un participant :		  
	<input id="champ" type="text" value="">&nbsp;<a id="ajouter" class="btn">Ajouter</a><br>

	<br>
	<h3>Inviter des personnes à l'évenement</h3>

	<div class="selectDate">
	<textarea id="mailsArea" title="Adresses email s&eacute;par&eacute;es par une virgule" rows="4" style="color:grey" placeholder="Entrez ici les adresses mail séparées par une virgule ..."></textarea>
	<i class="checkmail mesicones icon-remove"></i>
	<a id="envoiLien" disabled="true" class="btn btn-primary">Envoyer Lien</a>
	</div>

	<script type="text/javascript" charset="utf-8">
	
	var color1 = "#FFFF99";
	var color2 = "gold";
	var color3 = "steelblue";

	$("table.datesTable td").css("background-color", color3);

	$("#mailsArea").live("keyup", function() {
		if (bonmail($(this).val())) {
			$(".checkmail").attr("class", "checkmail mesicones icon-ok");
			$("#envoiLien").removeAttr("disabled");
		} else {
			$(".checkmail").attr("class", "checkmail mesicones icon-remove");
			$("#envoiLien").attr("disabled", "true");
		}
	})

	function bonmail(mailtest)
	{
		var reg = new RegExp('^([a-z0-9]+([_|\.|-]{1}[a-z0-9]+)*@@[a-z0-9]+([_|\.|-]{1}[a-z0-9]+)*[\.]{1}[a-z]{2,6}){1}(\,[a-z0-9]+([_|\.|-]{1}[a-z0-9]+)*@@[a-z0-9]+([_|\.|-]{1}[a-z0-9]+)*[\.]{1}[a-z]{2,6})*$', 'i');

		if(reg.test(mailtest))
		{
			return(true);
		}
		else
		{
			return(false);
		}
	}

	$(function(){ //Lancé au chargement/rafraichissement de la page	
		
		$(".checkbox").attr("disabled", "true"); 

		refreshObligatoire(); 
		

		$(".obligatoirecb").live("click", function() { //click sur la cherckbox "obligatoire" : mise à jour des classes sur la ligne, ajout de la propriété obligatoire dans la bdd
			
			var idParticipant = $(this).parent().parent().parent().attr("id");
			if ($(this).html() == "Obligatoire") {
				$(this).html("Facultatif");
				$(this).attr("class", "obligatoirecb btn");
			} else {
				$(this).html("Obligatoire");
				$(this).attr("class", "obligatoirecb btn btn-inverse");
			}
			$.ajax({
				type: "POST",
				url: "@routes.Application.changeObligatoire(event.id)",
				data: '{"idpersonne" : "' + idParticipant + '"}',
				contentType: "application/json",
				success : function(data) {
				  affichagePopulaire();
				}
	   		});
	   		refreshObligatoire();

		})

		$('.checkbox').each(function (i) { // coloration des box checkées
		  	if ($(this).is(':checked')){
		  		$(this).parent().css("background-color", "#66CC99");
		  	}
		});

		$('.infoPersonne').each(function (i) {
		  	$('.titres').attr('style','');
		});

		refreshCount(); // maj de la ligne de compteurs

		affichagePopulaire(); // maj des surbrillances
	  
	});
	
	$("textarea").live('click', function(e) {
		$(this).html("");
		$(this).removeAttr("style");
	})


	$('#envoiLien').live('click', function(e) {

		if ($(this).attr("disabled") != "disabled") {
		  	var mailsList = $("#mailsArea").val();
		  
			$.ajax({
				type: "POST",
				url: "@routes.Application.sendMail(event.id)",
				data: '{"mailslist" : "' + mailsList + '"}',
				contentType: "application/json",
				success : function(data) {
				  alert("Mail(s) envoye(s) a "+mailsList);
				}
		   });
		}
	});
		  
		  
	$('.deletePersonne').live('click', function(e) {    
	    $(this).parent().parent().parent().remove();
	    
	    
	    deletePersonne($(this).attr('id'));
	    if($('td[class="infoPersonne"]').html() == null) {
	    	$('.titres').attr('style','display:none');
	    }
	    $('#compte').children('td[id!=""]').each(function(i) {$(this).html("0")});

	    refreshCount();
	    
	})

	$('.editPersonne').live('click', function(e) {
		
	    if(!$(this).parents("tr").hasClass("editable"))  {	    	
	    	if ($(this).siblings("i").hasClass("icon-lock")){
				var pass = prompt('Entrez votre mot de passe','Mot_de_passe');
				var thisse = $(this);
				$.ajax({
					type: "POST",
					url: "@routes.Application.getPass()",
					data: '{ "idpers" : "'+$(this).parents("tr").attr("id")+'" }',
					contentType: "application/json",
					success : function(data) {
					  if (pass == data.pass) {
					  	edition(thisse);
					  } else {
					  	alert("mot de passe incorrect");
					  }
					}
			   });
			} else {
				edition($(this));
			}
		  
	    } else {
	      $(this).html("<i class=\"mesicones icon-pencil\"></i>");
	      $(this).parents("tr").removeClass("editable");
	      $(this).siblings('input[type="text"]').attr("readonly", "readonly");
	      $(this).parent().parent().parent().children("td").children('input[type="checkbox"]').attr("disabled","true"); 
	      $(this).parent().parent().parent().children("td").css("border", "none");
	      $(".hoverable").off();	      
	      $(this).parent().parent().parent().children(".checktd").attr("class", "checktd");
	      refreshHoverable();
	      editPersonne($(this).attr('id'), $(this).siblings("input").attr("value"));
	    }
	
	  
	})

	function edition(elem) {
		elem.html("<i class=\"mesicones icon-ok\"></i>");
		elem.parents("tr").addClass("editable");
		elem.siblings('input[type="text"]').removeAttr("readonly");
		elem.parent().parent().parent().children("td").children().removeAttr("disabled");
		elem.parent().parent().parent().children("td").css("border", "solid black 2px");
		$(".hoverable").off();		  
		elem.parent().parent().parent().children(".checktd").attr("class", "checktd hoverable");
		refreshHoverable();
	}
	
	function refreshHoverable() {
		
		$(".hoverable").on({

			mouseenter: function () {
				$(this).css("background-color", "lightgreen");
			}, 

			mouseleave: function () {
				if ($(this).children().is(':checked')){	 
			    	$(this).css("background-color", "#66CC99");
			    } else {
			    	$(this).css("background-color", color3);
			    }
			}
		});

	}

	function refreshObligatoire() {
		$(".checktd").removeClass("obligatoire");
		$(".checkbox").removeClass("obligatoire");
			$(".obligatoirecb").each(function () {
				//alert("test");
				//alert($(this).parent().parent().siblings(".checktd").html());
				if($(this).html() == "Obligatoire") {					
					$(this).parent().parent().siblings(".checktd").addClass("obligatoire");
					$(this).parent().parent().siblings(".checktd").children().addClass("obligatoire");
				}

			})
	}

	$("#ajouter").live('click', function(e){
		

	    var vide = "";	    
	    var nom = $.trim($("#champ").attr("value"));
	    if (nom != vide) {  
	    	var s;
		    var answer = confirm ("Voulez-vous sécuriser vos informations?");
			if (answer) {
		    	s=prompt('Entrez votre mot de passe','Mot_de_passe');
		    	addPersonne($.trim(nom), "true", s);	    
		    } else {
		    	addPersonne($.trim(nom), "false", "");
		    }    
						
		}

	    	    
	});

	$("#champ").keypress(function(e) {
		var code = (e.keyCode ? e.keyCode : e.which);
		if(code == 13) { //Enter keycode
			var vide = "";	    
		    var nom = $.trim($("#champ").attr("value"));
		    if (nom != vide) {  
		    	var s;
			    var answer = confirm ("Voulez-vous sécuriser vos informations?");
				if (answer) {
			    	s=prompt('Entrez votre mot de passe','Mot_de_passe');
			    	addPersonne($.trim(nom), "true", s);	    
			    } else {
			    	addPersonne($.trim(nom), "false", "");
			    }    
							
			}
			$("#champ").focus();
 		}

	});

	function refreshCount() {
		$('input[type="checkbox"].horaire.checkbox').each(function(i) {
			var iden = $(this).attr('id');
			
			if ($(this).is(':checked')){
		    	var increment = $('#compte').children('.horaire[id="'+iden+'"]');
				increment.html(parseInt(increment.html())+1);
			}
			
		});
			
		$('input[type="checkbox"].jour.checkbox').each(function(i) {
			var iden = $(this).attr('id');			
				
			if ($(this).is(':checked')){
		    	var increment = $('#compte').children('.jour[id="'+iden+'"]');
				increment.html(parseInt(increment.html())+1);
			}			
			
		});
	}

	function editPersonne(personneId, personneNom)
	{
	  $.ajax({
			type: "POST",
			url: "@routes.Application.updatePersonne(event.id)",
			data: '{"id" : "' + personneId + '", "nom" : "' + personneNom + '"}',
			contentType: "application/json",
			success : function(data) {
			  //alert("Participant edit\351");
			}
	  });
	}

	function deletePersonne(persId)
	{
	  $.ajax({
			type: "POST",
			url: "@routes.Application.deleteParticipant(event.id)",
			data: '{"id" : "' + persId + '"}',
			contentType: "application/json",
			success : function(data) {
			  //alert("Participant supprim\351");
			}
	  });
	}

	function addPersonne(nomParticipant, locked, pwd)
	{	
		$.ajax({
			type: "POST",
			url: "@routes.Application.addParticipant(event.id)",
			data: '{"nom" : "' + nomParticipant + '", "locked" : "' + locked + '", "pwd" : "' + pwd + '"}',
			contentType: "application/json",
			success : function(data) {
				var lock ="";		
				if(locked == "true"){
					lock = "<i class=\"mesicones icon-lock\"></i>&nbsp;";
				}  
				$("tbody").append("<tr title=\""+nomParticipant+"\" class=\"editable\" id=\""+data.idPersonne+"\"><td class=\"infoPersonne\">"+
					"<form id=\"formPersonne\">"+
					lock+
					"<a id=\"obligatoire\" class=\"obligatoirecb btn\">Facultatif</a>&nbsp;"+
					"<input id=\"nom\" type=\"text\" value=\""+nomParticipant+"\" name=\"nom\">&nbsp;"+	
					"<a id=\""+data.idPersonne+"\" title=\"editer le participant\" class=\"editPersonne\"><i class=\"mesicones icon-ok\"></i></a>"+
					"<a id=\""+data.idPersonne+"\" title=\"supprimer le participant\" class=\"deletePersonne\"> <i class=\"mesicones icon-trash\"></i</a>"+		  
					"</form></td>"+
					"@for(jour <- event.jours) {"+  
					"@if(jour.horaires.size() == 0){<td class=\"checktd hoverable\" style=\"border: solid black 2px\"><input id=\"@jour.id\" type=\"checkbox\" class=\"jour checkbox\" value=\"@jour.date\" /></td>}"+
					"@for(horaire <- jour.horaires) {"+	                		
					"<td class=\"checktd hoverable\" style=\"border: solid black 2px\"><input id=\"@horaire.id\" type=\"checkbox\" class=\"horaire checkbox\" value=\"@horaire.debut - @horaire.fin\" /></td>"+			                
					"}"+                	                
					"}" +
					"</tr>")
				$('#champ').attr('value', '')
				$('.titres').attr('style','');
				refreshHoverable();
						
			}               
		});
	}


	$('.checktd').live('click', function(e) {
		if ($(this).children().prop("disabled") == false) {
			if ($(this).children().prop("checked") == false) {
				if (e.target.nodeName == "TD"){
					$(this).children().prop("checked", true);
				}
				changeCheck($(this).children());
			} else {
				if (e.target.nodeName == "TD"){
					$(this).children().prop("checked", false);
				}        
				changeCheck($(this).children());
			}

			affichagePopulaire();

			//$('.populaires').html("");
			$('.titres td').each( function() {
				if ($(this).css('background-color') == color2) {
					$('.populaires').append($(this).html());
				}				
			})			
		}
	});
	
	function affichagePopulaire() {
		var max = 0;
		$("#compte").children(".horaire, .jour").each( function() { // récupération de la valeur maximale dans les comptes
			$(this).css("background-color", color1) 
			$('.titres').children().css("background-color",color1);
			//$('.footer').html("");
			if (checkobligatoire($(this).attr("id"), $(this).attr("class"))) {			
				if ($(this).html() > max) {			
					max = $(this).html();
				}
			}		
		})
		$("#compte").children().each( function() {
			
			if ($(this).html() == max && $(this).html() != 0 && checkobligatoire($(this).attr("id"), $(this).attr("class"))) {			
				$(this).css("background-color", color2);
				//alert("classe : "+$(this).attr("class")+" id : "+$(this).attr("id"));
				$('td[id="'+$(this).attr("id")+'"][class="'+$(this).attr("class")+'"]').css("background-color", color2);
				if($(this).attr("class") == "horaire") {
					var day = $('td[id="'+$(this).attr("id")+'"][class="'+$(this).attr("class")+'"]').attr("day");				
					$("td:contains('"+day+"')").css("background-color", color2);
					
				}
			}
		})
	}
	
	function checkobligatoire(idtime, type) {//fonction qui renvoie true si tous les participants obligatoires sont présents.
		//alert(idtime);
		var ret = true;
		//alert("type :"+type + " " + idtime)
		$('.obligatoire.'+type+'[id="'+idtime+'"]').each(function() {			
			if(!($(this).is(":checked"))) {
				//alert("id:"+$(this).attr("id"));
				ret = false;
			}
		})
		return ret;
	}
 


	function changeCheck(box) {   
	   var idtime = box.attr('id');
	   var idParticipant = box.parent().parent().attr('id');   
	   
	   if (box.is(':checked')){	 //Action de valider une horaire  		
	       		box.parent().css("background-color", "#66CC99")//vert
		   		if (box.attr('class').indexOf('horaire') != -1) {
		            var increment = $('#compte').children('.horaire[id="'+idtime+'"]');
			   	    increment.html(parseInt(increment.html())+1);
		       	    requeteAjaxHeure(idtime, idParticipant);
			    }
	       		if (box.attr('class').indexOf('jour') != -1) {	
	    	   	    var increment = $('#compte').children('.jour[id="'+idtime+'"]');
			   	    increment.html(parseInt(increment.html())+1);
				    requeteAjaxJour(idtime, idParticipant);
			   }
	   } else { //Action de dévalider une horaires
	     
		    box.parent().css("background-color", color3) //
		    if (box.attr('class').indexOf('horaire') != -1) {
			    var increment = $('#compte').children('.horaire[id="'+idtime+'"]');
			    increment.html(parseInt(increment.html())-1);
			    requeteAjaxHeure(idtime, idParticipant);
		    }
		    if (box.attr('class').indexOf('jour') != -1) {
		        var increment = $('#compte').children('.jour[id="'+idtime+'"]');
			    increment.html(parseInt(increment.html())-1);
			    requeteAjaxJour(idtime, idParticipant);
		    }
	   }
	}

	function requeteAjaxJour(idtime, idParticipant)
	{
	  $.ajax({
			type: "POST",
			url: "@routes.Application.checkBoxJour(event.id)",
			data: '{"idjour" : "' + idtime + '", "idpersonne" : "' + idParticipant + '"}',
			contentType: "application/json",
			success : function(data) {
			  //alert("Jour edit\351");
			}
	   });
	}

	function requeteAjaxHeure(idtime, idParticipant)
	{
	  $.ajax({
			type: "POST",
			url: "@routes.Application.checkBoxHoraire(event.id)",
			data: '{"idhoraire" : "' + idtime + '", "idpersonne" : "' + idParticipant + '"}',
			contentType: "application/json",
			success : function(data) {
			  //alert("Horaire edit\351");
			}
	   });
	}



	</script>

}
